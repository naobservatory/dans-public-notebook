{
  "hash": "5d8da7ebfa354944e159a69ba20f3d4f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Simulating the sensitivity of swabs and wastewater\"\ndraft: true\nformat:\n  html:\n    code-fold: false \n    toc: true\nexecute:\n  cache: false\nknitr:\n  opts_chunk: \n    message: false\neditor: source \nauthor: Dan Rice\ndate: 2025-07-03\ndate-modified: today\n---\n\n\n\n# Setup\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(knitr)\n# library(here)\nlibrary(slider)\nlibrary(kableExtra)\n\nset.seed(20250703)\n\ntheme_set(theme_minimal())\n\n# Colors borrowed from https://github.com/JLSteenwyk/ggpubfigs\nwong_eight <- c(\n  \"#E69F00\",\n  \"#56B4E9\",\n  \"#009E73\",\n  \"#F0E442\",\n  \"#0072B2\",\n  \"#D55E00\",\n  \"#CC79A7\",\n  \"#000000\"\n)\noptions(\n  ggplot2.discrete.colour = function()\n    scale_colour_manual(values = wong_eight)\n)\noptions(\n  ggplot2.discrete.fill = function()\n    scale_fill_manual(values = wong_eight)\n)\n\n# For axis labels\nscientific <- function(x) {\n  parse(text = sprintf(\"10^{%f}\", log10(x)))\n}\n\n# Geometric mean\ngm <- function(x) exp(mean(log(x)))\n\n# Load samples from posterior distributions\nposteriors <- read_tsv(\"https://raw.githubusercontent.com/naobservatory/swab-based-p2ra/refs/heads/main/tables/posteriors.tsv\")\n```\n:::\n\n\n\n# Model\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# All times in days\ndoubling_time <- 4\ngrowth_rate <- log(2) / doubling_time\nshedding_duration <- 7\n\n# TODO: implement sampling interval. Currently implicitly daily\n# sampling_interval <- 1\n\n# All lengths in bp\ngenome_length <- 7000\nread_length_swab <- 2000\nread_length_ww <- 300\n\n# Probability that a read covers the junction, assuming even coverage\npr_junction_swab <- read_length_swab / genome_length\npr_junction_ww <- read_length_ww / genome_length\n\nswab_pool_size <- 300\ntotal_reads_swab <- 2e6\ntotal_reads_ww <- 3e9\n\n# Number of reads to detect a junction\ndetection_threshold <- 1\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Assume deterministic exponential growth starting from one case\nditp_sewershed_population <- 2.5e6\n# Grow until ~50% of people have been infected\nmax_time <- floor(log(growth_rate * ditp_sewershed_population / 2) / growth_rate)\ntime <- 1:max_time\nincidence <- exp(time * growth_rate) / ditp_sewershed_population\ncumulative_incidence = cumsum(incidence)\n\n# Assume constant shedding for `shedding_duration` days\nshedding_prevalence <- slide_dbl(incidence, sum, .before = shedding_duration - 1, .complete = FALSE)\n```\n:::\n\n\n\n# Simulations\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Randomly downsample the posteriors for Rhinoviruses and Coronaviruses\nn_samples = 2000\nthinned_posteriors <- posteriors %>%\n  filter(group %in% c(\"Rhinoviruses\", \"Coronaviruses (seasonal)\", \"Coronaviruses (SARS-CoV-2)\")) %>%\n  select(species, group, mu_swab, phi_swab, mu_ww, phi_ww) %>%\n  group_by(species, group) %>%\n  slice_sample(n = n_samples) %>%\n  mutate(rep = 1:n()) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndetection <- thinned_posteriors %>%\n  cross_join(tibble(day = time, p = shedding_prevalence, ci = cumulative_incidence)) %>%\n  group_by(rep, .add = TRUE) %>%\n  mutate(\n    mean_ww = p * mu_ww * total_reads_ww * pr_junction_ww,\n    reads_ww = map2_int(phi_ww, mean_ww, ~ rnbinom(1, size = .x, mu = .y)),\n    cum_reads_ww = cumsum(reads_ww),\n    # Number of swabs from infected people\n    pos_swabs = map_int(p, ~ rbinom(1, size = swab_pool_size, prob = .x)),\n    mean_swab = (pos_swabs / swab_pool_size) * mu_swab * total_reads_swab * pr_junction_swab,\n    reads_swab = map2_int(phi_swab, mean_swab, ~ rnbinom(1, size = .x, mu = .y)),\n    cum_reads_swab = cumsum(reads_swab),\n  ) %>%\n  summarize(\n    mu_ww = first(mu_ww),\n    phi_ww = first(phi_ww),\n    mu_swab = first(mu_swab),\n    phi_swab = first(phi_swab),\n    # If undetected, use 100% CI\n    ci_at_detection_ww = if_else(\n      any(cum_reads_ww > detection_threshold),\n      ci[which.max(cum_reads_ww >= detection_threshold)],\n      1.0\n    ),\n    ci_at_detection_swab = if_else(\n      any(cum_reads_swab > detection_threshold),\n      ci[which.max(cum_reads_swab >= detection_threshold)],\n      1.0\n    ),\n  )\n```\n:::\n\n\n\n# Results\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngeom_means <- detection %>%\n  summarize(\n    ci_at_detection_ww = gm(ci_at_detection_ww),\n    ci_at_detection_swab = gm(ci_at_detection_swab),\n    ratio = ci_at_detection_ww / ci_at_detection_swab,\n    .groups = \"drop\",\n  )\n\ngeom_means %>%\n  select(- group) %>%\n  rename(\n    wastewater = ci_at_detection_ww,\n    swab = ci_at_detection_swab,\n  ) %>%\n  kable(digits = c(NA, 6, 6, 3)) %>%\n  column_spec(c(2, 3, 4), width = \"3cm\", monospace = TRUE) \n```\n\n::: {.cell-output-display}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> species </th>\n   <th style=\"text-align:right;\"> wastewater </th>\n   <th style=\"text-align:right;\"> swab </th>\n   <th style=\"text-align:right;\"> ratio </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> HCoV-229E </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.000723 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.000628 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 1.150 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> HCoV-HKU1 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.004282 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.001516 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 2.824 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> HCoV-NL63 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.003247 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.002431 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 1.336 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> HCoV-OC43 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.001137 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.001654 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.688 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rhinovirus A </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.004315 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.003939 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 1.096 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rhinovirus B </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.005166 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.001764 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 2.930 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rhinovirus C </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.000721 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.001370 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.526 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> SARS-CoV-2 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.000018 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.000966 </td>\n   <td style=\"text-align:right;width: 3cm; font-family: monospace;\"> 0.019 </td>\n  </tr>\n</tbody>\n</table>\n\n\n\nGeometric mean CI at detection\n:::\n:::\n\n::: {.cell .fig-cap-location-top}\n\n```{.r .cell-code}\ndetection %>%\n  ggplot(aes(ci_at_detection_swab, ci_at_detection_ww, color = group)) +\n  geom_abline(intercept = 0, slope = 1, color = \"grey\") +\n  geom_density_2d() +\n  geom_point(data = geom_means, color = \"black\") +\n  scale_x_log10() +\n  scale_y_log10() +\n  facet_wrap(~species, nrow = 2) +\n  theme(legend.position = \"none\") +\n  labs(x = NULL, y = NULL)\n  # labs(x = \"CI at swab detection\", y = \"CI at wastewater detection\")\n```\n\n::: {.cell-output-display}\n![Black dot show geometric means. Grey line is equal incidence.](index_files/figure-html/joint-distribution-1.png){width=672}\n:::\n\nCumulative incidence at detection: wastewater vs. swab\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndetection %>%\n  mutate(ratio = ci_at_detection_ww / ci_at_detection_swab) %>%\n  ggplot(aes(ratio, species, fill = group)) +\n  geom_violin(draw_quantiles = c(0.15, 0.5, 0.85)) +\n  scale_x_continuous(transform = \"log10\", labels = scientific) +\n  theme(legend.position = \"none\") +\n  labs(x = NULL, y = NULL)\n```\n\n::: {.cell-output-display}\n![Vertical bars are 15, 50, and 85th percentiles](index_files/figure-html/ratio-1.png){width=672}\n:::\n\nCI at wastewater detection / CI at swab detection\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}